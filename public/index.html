<!-- 
    ARQUIVO: index.html (Atualizado com correção de leitura de propriedades do usuário)
-->

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conecta Saúde - Sistema Integrado v2.6 (Patch)</title>
    
    <!-- Bibliotecas e Dependências (Mantidas) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <!-- Estilos (Mantidos do original, apenas resumidos aqui) -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&family=Merriweather:ital,wght@0,300;0,700;1,300&display=swap');
        body { font-family: 'Lato', sans-serif; background-color: #f0f9ff; }
        #splash-screen { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: #0f172a; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; transition: opacity 1s ease-out; }
        .splash-content { text-align: center; animation: pulse-slow 3s infinite; }
        .splash-image { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; opacity: 0.3; filter: grayscale(100%) contrast(120%); }
        .splash-title { font-family: 'Merriweather', serif; font-size: 3rem; font-weight: 700; letter-spacing: 2px; position: relative; z-index: 10; text-shadow: 0 4px 6px rgba(0,0,0,0.5); margin-bottom: 0.5rem; }
        .splash-loader { width: 200px; height: 2px; background: #1e293b; margin-top: 2rem; position: relative; z-index: 10; overflow: hidden; border-radius: 2px; }
        .splash-bar { width: 100%; height: 100%; background: #3b82f6; transform: translateX(-100%); animation: loading-bar 4s ease-in-out forwards; }
        @keyframes loading-bar { 0% { transform: translateX(-100%); } 100% { transform: translateX(0%); } }
        @keyframes pulse-slow { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
        .tab-active { border-bottom: 3px solid #1e3a8a; color: #1e3a8a; font-weight: 800; background-color: #eff6ff; }
        .tab-inactive { color: #64748b; cursor: pointer; transition: all 0.2s; }
        .tab-inactive:hover { color: #1e3a8a; background-color: #f1f5f9; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #1e3a8a; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #pdf-content-wrapper { position: fixed; top: 0; left: -9999px; width: 794px; z-index: -1000; opacity: 0; pointer-events: none; background: white; }
        .pdf-report { width: 794px; min-height: 1123px; padding: 0; margin: 0; background-color: #ffffff; color: #000; font-family: 'Arial', sans-serif; font-size: 12pt; line-height: 1.5; }
        .house-input { background-color: #f8fafc; border: 1px solid #cbd5e1; transition: all 0.3s; }
        .house-input:focus { border-color: #1e3a8a; box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.2); outline: none; }
        .animate-fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .map-link-card { display: flex; align-items: center; padding: 1rem; background: white; border: 1px solid #e2e8f0; border-radius: 0.75rem; transition: all 0.2s; cursor: pointer; text-decoration: none; color: #1e293b; }
        .map-link-card:hover { border-color: #3b82f6; background-color: #eff6ff; transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .toggle-checkbox:checked { right: 0; border-color: #ef4444; }
        .toggle-checkbox:checked + .toggle-label { background-color: #ef4444; }
        .exam-checkbox:checked { right: 0; border-color: #10B981; }
        .exam-checkbox:checked + .exam-label { background-color: #10B981; }
        .btn-speak { background-color: #e0f2fe; color: #0284c7; padding: 6px 12px; border-radius: 9999px; font-size: 0.8rem; font-weight: bold; transition: all 0.2s; display: inline-flex; align-items: center; gap: 5px; cursor: pointer; border: 1px solid #bae6fd; }
        .btn-speak:hover { background-color: #bae6fd; transform: scale(1.05); }
        .btn-pause { background-color: #fef9c3; color: #b45309; padding: 6px 12px; border-radius: 9999px; font-size: 0.8rem; font-weight: bold; transition: all 0.2s; display: inline-flex; align-items: center; gap: 5px; cursor: pointer; border: 1px solid #fde047; }
        .btn-pause:hover { background-color: #fde047; transform: scale(1.05); }
        .credits-high { background-color: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .credits-med { background-color: #fef9c3; color: #854d0e; border: 1px solid #fde047; }
        .credits-low { background-color: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(4px); z-index: 9999; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal-card { background: white; width: 90%; max-width: 500px; border-radius: 1rem; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); overflow: hidden; transform: scale(0.95); transition: transform 0.3s; }
        .modal-overlay.active .modal-card { transform: scale(1); }
    </style>
</head>

<body class="bg-slate-50 min-h-screen text-slate-800">
    <div id="toast-container" class="fixed top-4 right-4 z-[10000] flex flex-col gap-2 pointer-events-none"></div>

    <div id="splash-screen">
        <img src="https://images.unsplash.com/photo-1551076805-e1869033e561?q=80&w=2532&auto=format&fit=crop" class="splash-image" alt="Background Médico">
        <div class="splash-content">
            <h1 class="splash-title">CONECTA SAÚDE</h1>
            <p class="splash-subtitle">Sistema Integrado de Diagnóstico</p>
            <div class="splash-loader"><div class="splash-bar"></div></div>
            <p class="text-slate-400 text-xs mt-2 font-mono">Aplicando correções de banco de dados...</p>
        </div>
    </div>

    <!-- TELA DE LOGIN (Sem alterações estruturais) -->
    <div id="auth-view" class="fixed inset-0 z-40 bg-slate-900 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden animate-fade-in">
            <div class="bg-blue-900 p-6 text-center text-white">
                <i class="fa-solid fa-heart-pulse text-5xl mb-3"></i>
                <h1 class="text-2xl font-black uppercase">Conecta Saúde</h1>
                <p class="text-blue-200 text-xs">Acesso ao Prontuário Digital</p>
            </div>
            <div class="flex border-b">
                <button onclick="switchAuthTab('login')" id="tab-login" class="w-1/2 py-3 font-bold text-blue-900 bg-blue-50 border-b-2 border-blue-900">Entrar</button>
                <button onclick="switchAuthTab('register')" id="tab-register" class="w-1/2 py-3 text-gray-500 hover:text-blue-700">Criar Conta</button>
            </div>
            <div class="p-6">
                <form id="form-login" onsubmit="event.preventDefault(); handleEmailLogin();" class="space-y-4">
                    <div><label class="text-xs font-bold text-gray-600 uppercase">E-mail</label><input type="email" id="login-email" class="house-input w-full p-3 rounded" placeholder="email@exemplo.com"></div>
                    <div><label class="text-xs font-bold text-gray-600 uppercase">Senha</label><input type="password" id="login-password" class="house-input w-full p-3 rounded" placeholder="••••••"></div>
                    <button type="submit" class="w-full bg-blue-900 hover:bg-blue-800 text-white font-bold py-3 rounded shadow-lg transition">ACESSAR</button>
                    <div class="text-center mt-3"><button type="button" onclick="document.getElementById('recover-modal').classList.add('active')" class="text-xs text-blue-500 hover:text-blue-800 font-bold underline">Esqueci minha senha</button></div>
                </form>
                <form id="form-register" onsubmit="event.preventDefault(); handleRegister();" class="space-y-4 hidden">
                    <!-- Campos de registro simplificados para o exemplo -->
                    <div><label class="text-xs font-bold text-gray-600 uppercase">Nome</label><input type="text" id="reg-name" class="house-input w-full p-3 rounded"></div>
                    <div><label class="text-xs font-bold text-gray-600 uppercase">Email</label><input type="email" id="reg-email" class="house-input w-full p-3 rounded"></div>
                    <div><label class="text-xs font-bold text-gray-600 uppercase">CPF</label><input type="text" id="reg-cpf" class="house-input w-full p-3 rounded" maxlength="14" oninput="mascaraCPF(this)"></div>
                    <div><label class="text-xs font-bold text-gray-600 uppercase">Senha</label><input type="password" id="reg-password" class="house-input w-full p-3 rounded"></div>
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded shadow-lg">CADASTRAR</button>
                </form>
            </div>
        </div>
    </div>

    <!-- MAIN APP (Estrutura mantida) -->
    <div id="main-app" class="hidden min-h-screen pb-10">
        <!-- Navbar -->
        <nav class="bg-white shadow-sm sticky top-0 z-30">
            <div class="max-w-6xl mx-auto px-4">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <i data-lucide="activity" class="w-6 h-6 text-blue-600 mr-2"></i>
                        <span class="font-black text-xl text-blue-900 uppercase tracking-tight mr-4">Conecta Saúde</span>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="hidden sm:flex flex-col items-end">
                            <span id="user-display" class="text-sm font-bold text-gray-600"></span>
                            <div class="flex items-center gap-2">
                                <span id="credit-display" class="credits-badge credits-high"><i class="fa-solid fa-coins"></i> <span id="credit-val">0</span></span>
                                <button onclick="openRechargeModal()" class="bg-green-500 hover:bg-green-600 text-white rounded-full w-6 h-6 flex items-center justify-center shadow"><i class="fa-solid fa-plus"></i></button>
                            </div>
                        </div>
                        <button onclick="handleLogout()" class="text-xs text-red-500 hover:text-red-700 font-bold border border-red-200 px-3 py-1 rounded">SAIR</button>
                    </div>
                </div>
                <div class="flex overflow-x-auto">
                    <button id="btn-tab-0" onclick="switchTab(0)" class="tab-active flex-1 py-3 text-sm font-bold border-b-2 uppercase px-4"><i class="fa-solid fa-user-doctor mr-2"></i> Pré-Consulta</button>
                    <button id="btn-tab-1" onclick="switchTab(1)" class="tab-inactive flex-1 py-3 text-sm font-bold border-b-2 uppercase px-4"><i class="fa-solid fa-file-medical-alt mr-2"></i> Análise de Exames</button>
                    <button id="btn-tab-2" onclick="switchTab(2)" class="tab-inactive flex-1 py-3 text-sm font-bold border-b-2 uppercase px-4"><i class="fa-solid fa-hospital-user mr-2"></i> Pré-Operatório</button>
                </div>
            </div>
        </nav>

        <div class="max-w-5xl mx-auto p-4 sm:p-6 mt-4">
            <!-- ABA 0: PRÉ-CONSULTA -->
            <div id="page-0" class="block animate-fade-in">
                <!-- Conteúdo resumido para brevidade, mantendo IDs e classes originais -->
                <div class="bg-white rounded-xl shadow-lg border border-slate-200 p-6">
                    <h2 class="text-xl font-bold text-blue-900 mb-2">Solicitação Inteligente</h2>
                    <div id="pre-step-1" class="mb-6">
                        <h3 class="font-bold text-slate-700 uppercase text-xs mb-3">1. Confirmação</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 bg-slate-50 p-4 rounded border">
                            <div><label class="text-xs font-bold text-slate-500">Nome</label><input id="pre-name" class="house-input w-full p-2 rounded" disabled></div>
                            <div><label class="text-xs font-bold text-slate-500">Idade</label><input id="pre-age" class="house-input w-full p-2 rounded" disabled></div>
                            <button onclick="unlockPreConsulta()" id="btn-confirm-data" class="bg-blue-600 text-white font-bold py-2 rounded">Confirmar</button>
                        </div>
                    </div>
                    <div id="pre-step-2" class="hidden">
                         <!-- Opções de comorbidades -->
                         <button onclick="generateRationalExams()" id="btn-gen-exams" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg mt-4">Gerar Guia (80cr)</button>
                         <div id="pre-results" class="hidden mt-8 border-t pt-6">
                            <ul id="generated-exam-list" class="list-disc pl-5 text-sm"></ul>
                         </div>
                    </div>
                </div>
            </div>

            <!-- ABA 1: PÓS-CONSULTA (Resumido) -->
            <div id="page-1" class="hidden animate-fade-in">
                <div id="drop-zone-1" class="bg-white border-2 border-dashed border-blue-200 rounded-xl p-8 text-center cursor-pointer">
                    <input type="file" id="file-input-1" class="hidden" multiple onchange="handleFiles(this.files, 1)">
                    <div onclick="document.getElementById('file-input-1').click()">Clique para enviar exames</div>
                </div>
                <div id="results-1" class="hidden mt-4 bg-white p-6 rounded shadow">
                    <div id="ai-summary"></div>
                </div>
            </div>

            <!-- ABA 2: PRÉ-OPERATÓRIO (Resumido) -->
            <div id="page-2" class="hidden animate-fade-in">
                 <form id="preop-form" onsubmit="event.preventDefault(); processPreOp();" class="space-y-6">
                    <div class="bg-white p-6 rounded-xl border border-slate-200">
                        <select id="surgery-type" class="w-full p-2 border rounded bg-white mb-4"></select>
                        <div id="drop-zone-2" class="bg-blue-50 border-2 border-dashed border-blue-300 rounded-lg p-6 text-center cursor-pointer">
                            <input type="file" id="file-input-2" class="hidden" multiple onchange="handleFiles(this.files, 2)">
                            <div onclick="document.getElementById('file-input-2').click()">Anexar Exames</div>
                            <p id="file-count-2" class="text-xs mt-2">Nenhum arquivo</p>
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl">Calcular Risco (100cr)</button>
                 </form>
                 <div id="results-2" class="hidden mt-8 space-y-6">
                     <p id="res-asa" class="text-3xl font-bold"></p>
                     <div id="ai-content-2"></div>
                 </div>
            </div>
        </div>
    </div>

    <!-- PAINEL ADMIN (CORRIGIDO) -->
    <div id="admin-view" class="hidden min-h-screen bg-slate-50 pb-20">
        <div class="bg-slate-900 text-white p-6 shadow-lg flex justify-between">
            <h1 class="text-2xl font-black uppercase">Painel Administrativo</h1>
            <button onclick="handleLogout()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded font-bold">Sair</button>
        </div>
        <div class="max-w-6xl mx-auto p-6 space-y-8">
            <div class="bg-white rounded-xl shadow-md border border-red-100 overflow-hidden">
                <div class="bg-red-50 p-4 border-b border-red-100 flex justify-between">
                    <h2 class="text-lg font-bold text-red-900">Gestão de Pacientes</h2>
                    <input type="text" placeholder="Buscar..." oninput="filterUsers(this.value)" class="pl-4 py-2 text-sm border rounded-full">
                </div>
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                        <tr>
                            <th class="px-6 py-3">Paciente</th>
                            <th class="px-6 py-3 text-center">Créditos</th>
                            <th class="px-6 py-3 text-center">Ações</th>
                            <th class="px-6 py-3 text-center">Bloquear Pré-Consulta</th>
                            <th class="px-6 py-3 text-center">Bloquear Pré-Op</th>
                        </tr>
                    </thead>
                    <tbody id="admin-users-list" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- MODAL DE RECARGA -->
    <div id="recharge-modal" class="modal-overlay">
        <div class="modal-card p-6">
            <h3 class="font-bold text-lg mb-4">Recarga de Créditos</h3>
            <p id="modal-credit-val" class="text-4xl font-black text-center mb-6">0</p>
            <button onclick="initiatePayment('basic_50', 19.90)" class="w-full p-3 border rounded mb-2 hover:bg-slate-50">Pacote Básico (+50) - R$ 19,90</button>
            <button onclick="closeRechargeModal()" class="text-slate-400 w-full mt-4 text-sm">Fechar</button>
        </div>
    </div>
    
    <!-- MODAL RECUPERAÇÃO -->
    <div id="recover-modal" class="modal-overlay">
        <div class="modal-card bg-white p-6 w-96">
            <h3 class="font-bold text-lg mb-4">Recuperar Senha</h3>
            <input id="recover-cpf" class="house-input w-full p-3 rounded mb-4" placeholder="CPF">
            <input id="recover-new-pass" type="password" class="house-input w-full p-3 rounded mb-4 hidden" placeholder="Nova Senha">
            <button id="btn-recover" onclick="handleRecoveryStep()" class="w-full bg-blue-600 text-white font-bold py-2 rounded">BUSCAR</button>
            <button onclick="document.getElementById('recover-modal').classList.remove('active')" class="w-full text-slate-400 mt-2 text-sm">Cancelar</button>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script>
        const BACKEND_URL = window.location.hostname === 'localhost' ? "http://localhost:3000" : window.location.origin;
        let currentUser = null;
        let dbUsersList = [];
        let SYSTEM_SETTINGS = { exams: { lab: [], img: [] }, surgeries: [] };
        let currentPreOpFiles = [];
        let apiKey = "";

        // --- INICIALIZAÇÃO ---
        window.addEventListener('load', async () => {
            await loadConfig();
            setTimeout(() => { document.getElementById('splash-screen').style.opacity = '0'; setTimeout(() => document.getElementById('splash-screen').remove(), 1000); }, 2000);
        });

        async function loadConfig() {
            try {
                const res = await fetch(`${BACKEND_URL}/api/config`);
                if(res.ok) {
                    const data = await res.json();
                    apiKey = data.apiKey;
                }
            } catch(e) { console.error("Erro config:", e); }
        }

        // --- ADMIN: LISTAGEM DE USUÁRIOS CORRIGIDA ---
        async function fetchAdminUsers() {
            try {
                const res = await fetch(`${BACKEND_URL}/api/admin/users`);
                if (!res.ok) throw new Error("Erro ao buscar");
                dbUsersList = await res.json();
                renderUserList();
            } catch (error) {
                showToast("Erro ao carregar lista de usuários.", "error");
            }
        }

        function renderUserList(filter = '') {
            const container = document.getElementById('admin-users-list');
            const users = dbUsersList.filter(u => 
                u.name.toLowerCase().includes(filter.toLowerCase()) || 
                u.email.toLowerCase().includes(filter.toLowerCase())
            );
            
            container.innerHTML = users.map(user => {
                // --- CORREÇÃO AQUI: Tenta ler blockedFeatures (novo) ou blocked_features (antigo) ---
                const blocks = user.blockedFeatures || user.blocked_features || { preConsulta: false, preOp: false };
                
                return `
                <tr class="hover:bg-gray-50 transition">
                    <td class="px-6 py-4 font-medium text-gray-900">${user.name}<div class="text-xs text-gray-400 font-normal">${user.email}</div></td>
                    <td class="px-6 py-4 text-center"><span class="bg-green-100 text-green-800 px-2 py-0.5 rounded-full text-xs font-medium">${user.credits || 0} Créditos</span></td>
                    <td class="px-6 py-4 text-center"><button onclick="adminRecharge('${user.email}')" class="bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-1 px-3 rounded shadow">+100</button></td>
                    <td class="px-6 py-4 text-center">
                        <div class="relative inline-block w-10 mr-2 align-middle select-none">
                            <input type="checkbox" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer" 
                                   ${blocks.preConsulta ? 'checked' : ''} 
                                   onchange="toggleUserBlock('${user.email}', 'preConsulta', this)"/>
                            <label class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-300 cursor-pointer"></label>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <div class="relative inline-block w-10 mr-2 align-middle select-none">
                            <input type="checkbox" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer" 
                                   ${blocks.preOp ? 'checked' : ''} 
                                   onchange="toggleUserBlock('${user.email}', 'preOp', this)"/>
                            <label class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-300 cursor-pointer"></label>
                        </div>
                    </td>
                </tr>
            `}).join('');
        }

        async function toggleUserBlock(email, feature, checkbox) {
            const isBlocked = checkbox.checked;
            try {
                const res = await fetch(`${BACKEND_URL}/api/admin/toggle_block`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ email, feature, isBlocked })
                });
                if(!res.ok) throw new Error();
                
                // Atualiza localmente
                const idx = dbUsersList.findIndex(u => u.email === email);
                if(idx > -1) {
                    if(!dbUsersList[idx].blockedFeatures) dbUsersList[idx].blockedFeatures = {};
                    dbUsersList[idx].blockedFeatures[feature] = isBlocked;
                }
                showToast("Permissão atualizada!", "success");
            } catch(e) {
                checkbox.checked = !isBlocked;
                showToast("Erro ao atualizar.", "error");
            }
        }

        async function adminRecharge(email) {
            if(!confirm("Adicionar 100 créditos?")) return;
            try {
                const res = await fetch(`${BACKEND_URL}/api/admin/recharge`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ email, amount: 100 })
                });
                if(res.ok) {
                    showToast("Recarga feita!", "success");
                    fetchAdminUsers();
                }
            } catch(e) { showToast("Erro.", "error"); }
        }

        // --- AUTH & LOGIN ---
        async function handleEmailLogin() {
            const e = document.getElementById('login-email').value;
            const p = document.getElementById('login-password').value;
            try {
                const res = await fetch(`${BACKEND_URL}/api/auth/login`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ email: e, password: p })
                });
                const data = await res.json();
                if(res.ok) initializeApp(data);
                else showToast(data.message, "error");
            } catch(err) { showToast("Erro de conexão.", "error"); }
        }

        function initializeApp(user) {
            currentUser = user;
            if(user.role === 'admin') {
                document.getElementById('admin-view').classList.remove('hidden');
                fetchAdminUsers();
            } else {
                document.getElementById('main-app').classList.remove('hidden');
                document.getElementById('user-display').textContent = user.name;
                document.getElementById('credit-val').textContent = user.credits;
                // Popula selects
                fetch(`${BACKEND_URL}/api/catalog`).then(r=>r.json()).then(d=>{
                    SYSTEM_SETTINGS = d;
                    const sel = document.getElementById('surgery-type');
                    sel.innerHTML = d.surgeries.filter(s=>s.ativo).map(s=>`<option value="${s.id}">${s.nome}</option>`).join('');
                });
                // Preenche dados
                document.getElementById('pre-name').value = user.name;
                document.getElementById('pre-age').value = user.age;
            }
            document.getElementById('auth-view').classList.add('hidden');
        }

        function handleLogout() { location.reload(); }
        function switchTab(i) {
             [0,1,2].forEach(n => document.getElementById(`page-${n}`).classList.add('hidden'));
             document.getElementById(`page-${i}`).classList.remove('hidden');
        }
        function switchAuthTab(t) {
            if(t==='login') { document.getElementById('form-login').classList.remove('hidden'); document.getElementById('form-register').classList.add('hidden'); }
            else { document.getElementById('form-login').classList.add('hidden'); document.getElementById('form-register').classList.remove('hidden'); }
        }
        function showToast(msg, type) {
            const el = document.createElement('div');
            el.className = `p-4 rounded shadow text-white font-bold ${type==='error'?'bg-red-500':'bg-green-600'}`;
            el.textContent = msg;
            document.getElementById('toast-container').appendChild(el);
            setTimeout(() => el.remove(), 3000);
        }
        
        // Outras funções utilitárias (mascaraCPF, etc) mantidas do original...
        function mascaraCPF(i){
            let v=i.value.replace(/\D/g,""); v=v.replace(/(\d{3})(\d)/,"$1.$2"); v=v.replace(/(\d{3})(\d)/,"$1.$2"); v=v.replace(/(\d{3})(\d{1,2})$/,"$1-$2"); i.value=v;
        }
    </script>
</body>
</html>