<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conecta Saúde - V2.5 Seguro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&display=swap');
        body { font-family: 'Lato', sans-serif; background-color: #f8fafc; }
        .house-input { background: #fff; border: 1px solid #e2e8f0; padding: 12px; border-radius: 8px; width: 100%; transition: 0.3s; }
        .btn-primary { background: #1e3a8a; color: white; font-weight: bold; padding: 12px; border-radius: 8px; width: 100%; transition: 0.2s; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-overlay.active { display: flex; }
    </style>
</head>
<body>

    <div id="toast-container" class="fixed top-4 right-4 z-[9999]"></div>

    <!-- Login/Registro -->
    <div id="auth-view" class="fixed inset-0 bg-slate-900 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
            <div class="bg-blue-900 p-8 text-center text-white">
                <i class="fa-solid fa-heart-pulse text-4xl mb-2"></i>
                <h1 class="text-2xl font-black uppercase">Conecta Saúde</h1>
                <p class="text-blue-300 text-xs">Acesso Seguro para Pacientes</p>
            </div>
            
            <div class="flex border-b">
                <button onclick="switchAuthTab('login')" id="tab-login" class="w-1/2 py-4 font-bold text-blue-900 border-b-2 border-blue-900">Entrar</button>
                <button onclick="switchAuthTab('register')" id="tab-register" class="w-1/2 py-4 text-gray-400">Criar Conta</button>
            </div>

            <div class="p-8">
                <!-- Login -->
                <form id="form-login" onsubmit="event.preventDefault(); handleLogin();" class="space-y-4">
                    <input type="email" id="login-email" class="house-input" placeholder="Seu e-mail" required>
                    <input type="password" id="login-password" class="house-input" placeholder="Sua senha" required>
                    <button type="submit" id="btn-login-action" class="btn-primary">ENTRAR</button>
                    <div class="text-center">
                        <button type="button" onclick="openRecoverModal()" class="text-xs text-blue-600 font-bold">Esqueci minha senha</button>
                    </div>
                </form>

                <!-- Registro -->
                <form id="form-register" onsubmit="event.preventDefault(); handleRegister();" class="space-y-3 hidden">
                    <input type="text" id="reg-name" class="house-input" placeholder="Nome Completo" required>
                    <div class="flex gap-2">
                        <input type="number" id="reg-age" class="house-input" placeholder="Idade" required>
                        <select id="reg-sex" class="house-input"><option value="M">Masculino</option><option value="F">Feminino</option></select>
                    </div>
                    <input type="text" id="reg-cpf" class="house-input" placeholder="CPF" oninput="maskCPF(this)" maxlength="14" required>
                    <input type="email" id="reg-email" class="house-input" placeholder="E-mail" required>
                    <input type="password" id="reg-password" class="house-input" placeholder="Crie uma senha" required>
                    <button type="submit" id="btn-register-action" class="btn-primary bg-green-600">CRIAR CONTA E RECEBER E-MAIL</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Notificação Pós-Cadastro -->
    <div id="activation-modal" class="modal-overlay">
        <div class="bg-white rounded-xl p-8 w-full max-w-sm shadow-2xl text-center">
            <div class="bg-blue-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fa-solid fa-envelope-open-text text-3xl text-blue-600"></i>
            </div>
            <h3 class="text-xl font-bold text-slate-800 mb-2">Quase lá!</h3>
            <p class="text-sm text-slate-500 mb-6">Enviamos um link de ativação para o seu e-mail. Por favor, clique no link para validar a sua conta e começar a usar.</p>
            <button onclick="closeActivationModal()" class="btn-primary">ENTENDI, VOU VERIFICAR</button>
        </div>
    </div>

    <!-- Recuperação de Senha -->
    <div id="recover-modal" class="modal-overlay">
        <div class="bg-white rounded-xl p-8 w-full max-w-sm shadow-2xl">
            <h3 class="text-xl font-bold text-slate-800 mb-2">Recuperar Senha</h3>
            <p class="text-sm text-slate-500 mb-6">Digite seu CPF para ver sua nova senha.</p>
            <input type="text" id="recover-cpf" class="house-input mb-4" placeholder="000.000.000-00" oninput="maskCPF(this)" maxlength="14">
            <div id="recover-result" class="hidden p-4 bg-green-50 border border-green-200 rounded-lg mb-4">
                <p class="text-xs text-green-800 font-bold">Nova Senha:</p>
                <p id="new-pass-display" class="text-lg font-mono font-black text-green-900"></p>
            </div>
            <div class="flex gap-2">
                <button onclick="handleRecoverPassword()" class="btn-primary flex-1">VERIFICAR</button>
                <button onclick="closeRecoverModal()" class="bg-slate-100 text-slate-600 px-4 py-2 rounded-lg font-bold">VOLTAR</button>
            </div>
        </div>
    </div>

    <!-- App Principal -->
    <div id="main-app" class="hidden">
        <nav class="bg-white shadow px-6 py-4 flex justify-between items-center">
            <h2 class="font-black text-blue-900 uppercase">Conecta Saúde</h2>
            <div class="flex items-center gap-4">
                <span id="user-info" class="text-sm font-bold"></span>
                <span id="credit-info" class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs font-black"></span>
                <button onclick="location.reload()" class="text-red-500 font-bold text-xs">SAIR</button>
            </div>
        </nav>
        <div class="p-8 max-w-4xl mx-auto text-center">
            <div class="bg-white p-12 rounded-2xl shadow-sm border border-slate-100">
                <i class="fa-solid fa-user-check text-5xl text-green-500 mb-4"></i>
                <h1 class="text-2xl font-black text-slate-800">Conta Ativa e Protegida!</h1>
                <p class="text-slate-500 mt-2">Você validou seu acesso via e-mail. Agora pode utilizar todas as ferramentas de IA.</p>
            </div>
        </div>
    </div>

    <script>
        const BACKEND_URL = "https://conecta-final.onrender.com";
        let currentUser = null;

        async function handleLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            try {
                const res = await fetch(`${BACKEND_URL}/auth/login`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();
                if(res.ok) {
                    currentUser = data.user;
                    startApp();
                } else {
                    showToast(data.error);
                }
            } catch(e) { showToast("Erro de conexão."); }
        }

        async function handleRegister() {
            const btn = document.getElementById('btn-register-action');
            btn.disabled = true;
            btn.innerText = "PROCESSANDO...";

            const payload = {
                name: document.getElementById('reg-name').value,
                age: document.getElementById('reg-age').value,
                sex: document.getElementById('reg-sex').value,
                cpf: document.getElementById('reg-cpf').value,
                email: document.getElementById('reg-email').value,
                password: document.getElementById('reg-password').value
            };

            try {
                const res = await fetch(`${BACKEND_URL}/auth/register`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if(res.ok) {
                    openActivationModal();
                    switchAuthTab('login');
                } else {
                    showToast(data.error);
                }
            } catch(e) { showToast("Erro no servidor."); }
            finally {
                btn.disabled = false;
                btn.innerText = "CRIAR CONTA E RECEBER E-MAIL";
            }
        }

        async function handleRecoverPassword() {
            const cpf = document.getElementById('recover-cpf').value;
            try {
                const res = await fetch(`${BACKEND_URL}/auth/recover-password`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ cpf })
                });
                const data = await res.json();
                if(res.ok) {
                    document.getElementById('recover-result').classList.remove('hidden');
                    document.getElementById('new-pass-display').innerText = data.newPassword;
                } else showToast(data.error);
            } catch(e) { showToast("Erro ao recuperar."); }
        }

        function startApp() {
            document.getElementById('auth-view').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('user-info').innerText = `Olá, ${currentUser.name}`;
            document.getElementById('credit-info').innerText = `${currentUser.credits} CRÉDITOS`;
        }

        function openRecoverModal() { document.getElementById('recover-modal').classList.add('active'); }
        function closeRecoverModal() { document.getElementById('recover-modal').classList.remove('active'); }
        function openActivationModal() { document.getElementById('activation-modal').classList.add('active'); }
        function closeActivationModal() { document.getElementById('activation-modal').classList.remove('active'); }
        
        function maskCPF(i) { let v = i.value.replace(/\D/g, ""); v = v.replace(/(\d{3})(\d)/, "$1.$2"); v = v.replace(/(\d{3})(\d)/, "$1.$2"); v = v.replace(/(\d{3})(\d{1,2})$/, "$1-$2"); i.value = v; }
        
        function switchAuthTab(t) { 
            const isL = t==='login'; 
            document.getElementById('form-login').classList.toggle('hidden', !isL); 
            document.getElementById('form-register').classList.toggle('hidden', isL); 
            document.getElementById('tab-login').className = isL ? "w-1/2 py-4 font-bold text-blue-900 border-b-2 border-blue-900" : "w-1/2 py-4 text-gray-400";
            document.getElementById('tab-register').className = !isL ? "w-1/2 py-4 font-bold text-blue-900 border-b-2 border-blue-900" : "w-1/2 py-4 text-gray-400";
        }
        
        function showToast(m, t="error") {
            const c = document.getElementById('toast-container');
            const d = document.createElement('div');
            d.className = `p-4 mb-2 rounded shadow-lg text-white font-bold ${t==='success'?'bg-green-600':'bg-red-600'}`;
            d.innerText = m; c.appendChild(d); setTimeout(()=>d.remove(), 4000);
        }
    </script>
</body>
</html>