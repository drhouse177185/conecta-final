<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conecta Saúde - V2.5 Seguro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&display=swap');
        body { font-family: 'Lato', sans-serif; background-color: #f8fafc; }
        
        /* --- SPLASH SCREEN (Tela de Abertura Escura) --- */
        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: #0f172a; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; transition: opacity 1s ease-out;
        }
        .splash-content { text-align: center; animation: pulse-slow 3s infinite; }
        .splash-image {
            width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0;
            opacity: 0.3; filter: grayscale(100%) contrast(120%);
        }
        .splash-title {
            font-family: 'Merriweather', serif; font-size: 3rem; font-weight: 700; letter-spacing: 2px;
            position: relative; z-index: 10; text-shadow: 0 4px 6px rgba(0,0,0,0.5); margin-bottom: 0.5rem;
        }
        .splash-subtitle {
            font-family: 'Lato', sans-serif; font-size: 0.9rem; letter-spacing: 4px;
            text-transform: uppercase; color: #94a3b8; position: relative; z-index: 10;
        }
        .splash-loader {
            width: 200px; height: 2px; background: #1e293b; margin-top: 2rem;
            position: relative; z-index: 10; overflow: hidden; border-radius: 2px;
        }
        .splash-bar {
            width: 100%; height: 100%; background: #3b82f6; transform: translateX(-100%);
            animation: loading-bar 3s ease-in-out forwards;
        }
        @keyframes loading-bar { 0% { transform: translateX(-100%); } 100% { transform: translateX(0%); } }
        @keyframes pulse-slow { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }

        /* --- UI UTILS --- */
        .house-input { background: #fff; border: 1px solid #e2e8f0; padding: 12px; border-radius: 8px; width: 100%; transition: 0.3s; margin-bottom: 10px; }
        .house-input:focus { border-color: #1e3a8a; outline: none; ring: 2px solid #1e3a8a20; }
        .btn-primary { background: #1e3a8a; color: white; font-weight: bold; padding: 12px; border-radius: 8px; width: 100%; transition: 0.2s; cursor: pointer; }
        .btn-primary:hover { background: #172554; }
        .btn-primary:disabled { background: #94a3b8; cursor: not-allowed; }
        
        /* Modais */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 50; }
        .modal-overlay.active { display: flex; }

        /* Loading Spinner */
        #loading-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(8px); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
        #loading-overlay.active { display: flex; }
        .spinner { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #3b82f6; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- SPLASH SCREEN -->
    <div id="splash-screen">
        <img src="https://images.unsplash.com/photo-1551076805-e1869033e561?q=80&w=2532&auto=format&fit=crop" class="splash-image" alt="Background Médico">
        <div class="splash-content">
            <h1 class="splash-title">CONECTA SAÚDE</h1>
            <p class="splash-subtitle">Sistema Integrado de Diagnóstico</p>
            <div class="splash-loader"><div class="splash-bar"></div></div>
            <p class="text-slate-400 text-xs mt-2 font-mono">Iniciando ambiente seguro...</p>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast-container" class="fixed top-4 right-4 z-[9999] flex flex-col gap-2 pointer-events-none"></div>

    <!-- LOADING INTERNO -->
    <div id="loading-overlay">
        <div class="spinner mb-4"></div>
        <p class="text-white font-bold text-lg animate-pulse" id="loading-text">Processando...</p>
    </div>

    <!-- LOGIN / REGISTRO (FUNDO ESCURO) -->
    <div id="auth-view" class="min-h-screen flex items-center justify-center p-4 relative bg-slate-900">
        <div class="absolute inset-0 z-0 overflow-hidden">
            <img src="https://images.unsplash.com/photo-1538108149393-fbbd81895907?q=80&w=2000&auto=format&fit=crop" alt="Medical Background" class="w-full h-full object-cover opacity-20 filter grayscale">
            <div class="absolute inset-0 bg-gradient-to-b from-slate-900/90 to-blue-900/90"></div>
        </div>

        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all hover:scale-[1.01] relative z-10">
            <div class="bg-blue-900 p-8 text-center text-white relative overflow-hidden">
                <div class="absolute inset-0 opacity-10 bg-[url('https://www.transparenttextures.com/patterns/medical-icons.png')]"></div>
                <i class="fa-solid fa-heart-pulse text-5xl mb-3 relative z-10"></i>
                <h1 class="text-3xl font-black uppercase relative z-10">Conecta Saúde</h1>
                <p class="text-blue-200 text-sm relative z-10">Portal do Paciente</p>
            </div>
            
            <div class="flex border-b">
                <button onclick="switchTab('login')" id="tab-login" class="w-1/2 py-4 font-bold text-blue-900 border-b-4 border-blue-900 bg-blue-50">Entrar</button>
                <button onclick="switchTab('register')" id="tab-register" class="w-1/2 py-4 text-slate-400 font-medium hover:text-blue-800">Criar Conta</button>
            </div>

            <div class="p-8">
                <form id="form-login" onsubmit="event.preventDefault(); handleLogin();" class="space-y-4">
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase">E-mail</label>
                        <div class="relative">
                            <i class="fa-solid fa-envelope absolute left-3 top-3.5 text-slate-400"></i>
                            <input type="email" id="login-email" class="house-input pl-10" placeholder="seu@email.com" required>
                        </div>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase">Senha</label>
                        <div class="relative">
                            <i class="fa-solid fa-lock absolute left-3 top-3.5 text-slate-400"></i>
                            <input type="password" id="login-password" class="house-input pl-10" placeholder="••••••••" required>
                        </div>
                    </div>
                    <button type="submit" class="btn-primary shadow-lg shadow-blue-900/30">ACESSAR SISTEMA</button>
                    <div class="text-center mt-4">
                        <button type="button" onclick="openModal('recover-modal')" class="text-sm text-blue-600 font-bold hover:underline">Esqueceu a senha?</button>
                    </div>
                </form>

                <form id="form-register" onsubmit="event.preventDefault(); handleRegister();" class="space-y-3 hidden">
                    <input type="text" id="reg-name" class="house-input" placeholder="Nome Completo" required>
                    <div class="flex gap-2">
                        <input type="number" id="reg-age" class="house-input" placeholder="Idade" required>
                        <select id="reg-sex" class="house-input">
                            <option value="" disabled selected>Sexo</option>
                            <option value="M">Masculino</option>
                            <option value="F">Feminino</option>
                        </select>
                    </div>
                    <input type="text" id="reg-cpf" class="house-input" placeholder="CPF (000.000.000-00)" oninput="maskCPF(this)" maxlength="14" required>
                    <input type="email" id="reg-email" class="house-input" placeholder="E-mail" required>
                    <input type="password" id="reg-password" class="house-input" placeholder="Crie uma Senha" required>
                    <button type="submit" class="btn-primary bg-green-600 hover:bg-green-700 shadow-lg shadow-green-900/30">CRIAR CONTA GRÁTIS</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Pós-Cadastro -->
    <div id="activation-modal" class="modal-overlay">
        <div class="bg-white rounded-xl p-8 w-full max-w-sm shadow-2xl text-center transform transition-all scale-100">
            <div class="bg-blue-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fa-solid fa-envelope-open-text text-3xl text-blue-600"></i>
            </div>
            <h3 class="text-xl font-bold text-slate-800 mb-2">Verifique seu E-mail</h3>
            <p class="text-sm text-slate-500 mb-6">Enviamos um link de confirmação. Clique nele para ativar sua conta.</p>
            <button onclick="closeModal('activation-modal')" class="btn-primary">ENTENDI</button>
        </div>
    </div>

    <!-- Modal Recuperação -->
    <div id="recover-modal" class="modal-overlay">
        <div class="bg-white rounded-xl p-8 w-full max-w-sm shadow-2xl transform transition-all scale-100">
            <div class="text-center mb-6">
                <div class="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fa-solid fa-key text-2xl text-blue-600"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-800">Recuperar Acesso</h3>
            </div>
            <input type="text" id="recover-cpf" class="house-input text-center font-bold text-lg tracking-widest" placeholder="000.000.000-00" oninput="maskCPF(this)" maxlength="14">
            <div id="recover-result" class="hidden mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg text-center animate-pulse">
                <p class="text-xs text-yellow-800 font-bold uppercase mb-1">Sua Nova Senha:</p>
                <p id="new-pass-display" class="text-2xl font-mono font-black text-slate-800 select-all"></p>
            </div>
            <div class="flex gap-2 mt-6">
                <button onclick="handleRecoverPassword()" class="btn-primary flex-1">GERAR SENHA</button>
                <button onclick="closeModal('recover-modal')" class="px-4 py-2 rounded-lg font-bold text-slate-500 hover:bg-slate-100">FECHAR</button>
            </div>
        </div>
    </div>

    <!-- APP PRINCIPAL -->
    <div id="main-app" class="hidden min-h-screen flex flex-col">
        <nav class="bg-white shadow-md px-6 py-4 flex justify-between items-center z-40 relative">
            <div class="flex items-center gap-3">
                <div class="bg-blue-100 p-2 rounded-lg text-blue-700"><i class="fa-solid fa-heart-pulse"></i></div>
                <h2 class="font-black text-blue-900 uppercase tracking-tight hidden sm:block">Conecta Saúde</h2>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-right hidden sm:block">
                    <p id="user-name-display" class="text-sm font-bold text-slate-700">Usuário</p>
                    <p class="text-xs text-slate-400">Paciente</p>
                </div>
                <div class="bg-blue-50 px-4 py-2 rounded-full border border-blue-100 flex items-center gap-2">
                    <i class="fa-solid fa-coins text-yellow-500"></i>
                    <span id="credit-display" class="text-blue-800 font-black text-sm">0</span>
                </div>
                <button onclick="logout()" class="text-red-500 hover:bg-red-50 p-2 rounded-lg transition"><i class="fa-solid fa-right-from-bracket"></i></button>
            </div>
        </nav>

        <main class="flex-1 p-6 max-w-5xl mx-auto w-full">
            <div class="bg-gradient-to-r from-blue-600 to-blue-800 rounded-2xl p-8 text-white shadow-xl mb-8 relative overflow-hidden">
                <i class="fa-solid fa-user-doctor absolute -right-10 -bottom-10 text-9xl opacity-20 rotate-12"></i>
                <h1 class="text-3xl font-bold mb-2">Bem-vindo(a) de volta!</h1>
                <p class="opacity-90 max-w-lg">Sua saúde em dia com o poder da inteligência artificial. Utilize seus créditos para gerar diagnósticos preliminares.</p>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-robot text-blue-500"></i> Consultar IA Médica
                </h3>
                <textarea id="ai-prompt" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-4 h-32 focus:ring-2 focus:ring-blue-500 focus:outline-none resize-none transition" placeholder="Descreva seus sintomas ou dúvida de saúde aqui..."></textarea>
                <div class="flex justify-between items-center mt-4">
                    <span class="text-xs text-slate-400 font-bold uppercase"><i class="fa-solid fa-tag"></i> Custo: 10 Créditos</span>
                    <button onclick="generateAI()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700 transition flex items-center gap-2">
                        ANALISAR AGORA <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </div>
                
                <div id="ai-result-area" class="mt-6 hidden">
                    <div class="bg-green-50 border border-green-100 rounded-lg p-6">
                        <h4 class="text-green-800 font-bold mb-2 flex items-center gap-2"><i class="fa-solid fa-check-circle"></i> Análise Concluída:</h4>
                        <p id="ai-response-text" class="text-slate-700 leading-relaxed whitespace-pre-wrap"></p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Use caminho relativo para evitar erros de CORS ou URL errada
        const API_URL = ""; 
        let currentUser = null;

        window.addEventListener('load', () => {
            setTimeout(() => {
                const splash = document.getElementById('splash-screen');
                splash.style.opacity = '0';
                setTimeout(() => splash.remove(), 1000);
            }, 3000);
        });

        function showLoading(msg = "Processando...") {
            document.getElementById('loading-text').innerText = msg;
            document.getElementById('loading-overlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.remove('active');
        }

        async function handleLogin() {
            showLoading("Autenticando...");
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            try {
                const res = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();
                
                if (res.ok) {
                    currentUser = data.user;
                    enterApp();
                    showToast("Login realizado com sucesso!", "success");
                } else {
                    showToast(data.error || "Erro ao entrar.");
                }
            } catch (error) {
                showToast("Erro de conexão com o servidor.");
                console.error(error);
            } finally {
                hideLoading();
            }
        }

        async function handleRegister() {
            showLoading("Criando conta e enviando e-mail...");
            const payload = {
                name: document.getElementById('reg-name').value,
                age: document.getElementById('reg-age').value,
                sex: document.getElementById('reg-sex').value,
                cpf: document.getElementById('reg-cpf').value,
                email: document.getElementById('reg-email').value,
                password: document.getElementById('reg-password').value
            };

            try {
                const res = await fetch(`${API_URL}/auth/register`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const data = await res.json();

                if (res.ok) {
                    openModal('activation-modal');
                    switchTab('login');
                } else {
                    showToast(data.error);
                }
            } catch (error) {
                showToast("Erro ao conectar com o servidor.");
            } finally {
                hideLoading();
            }
        }

        async function handleRecoverPassword() {
            showLoading("Gerando nova senha...");
            const cpf = document.getElementById('recover-cpf').value;

            try {
                const res = await fetch(`${API_URL}/auth/recover-password`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ cpf })
                });
                const data = await res.json();

                if (res.ok) {
                    document.getElementById('recover-result').classList.remove('hidden');
                    document.getElementById('new-pass-display').innerText = data.newPassword;
                    showToast("Senha gerada!", "success");
                } else {
                    showToast(data.error);
                }
            } catch (error) {
                showToast("Erro na recuperação.");
            } finally {
                hideLoading();
            }
        }

        async function generateAI() {
            if (!currentUser) return logout();
            const prompt = document.getElementById('ai-prompt').value;
            if(!prompt.trim()) return showToast("Digite algo para a IA analisar.");

            showLoading("IA Analisando Dados...");
            try {
                const res = await fetch(`${API_URL}/ai/generate`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        prompt, userId: currentUser.id, cost: 10, isJson: false 
                    })
                });
                const data = await res.json();

                if (res.ok) {
                    document.getElementById('ai-result-area').classList.remove('hidden');
                    document.getElementById('ai-response-text').innerText = data.result;
                    currentUser.credits = data.new_credits;
                    document.getElementById('credit-display').innerText = currentUser.credits;
                } else {
                    showToast(data.error);
                }
            } catch (error) {
                showToast("Erro ao consultar IA.");
            } finally {
                hideLoading();
            }
        }

        function enterApp() {
            document.getElementById('auth-view').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('user-name-display').innerText = currentUser.name;
            document.getElementById('credit-display').innerText = currentUser.credits;
        }

        function logout() { currentUser = null; location.reload(); }

        function switchTab(tab) {
            const isLogin = tab === 'login';
            document.getElementById('form-login').classList.toggle('hidden', !isLogin);
            document.getElementById('form-register').classList.toggle('hidden', isLogin);
            
            const tabLogin = document.getElementById('tab-login');
            const tabRegister = document.getElementById('tab-register');
            
            if(isLogin) {
                tabLogin.className = "w-1/2 py-4 font-bold text-blue-900 border-b-4 border-blue-900 bg-blue-50";
                tabRegister.className = "w-1/2 py-4 text-slate-400 font-medium hover:text-blue-800";
            } else {
                tabRegister.className = "w-1/2 py-4 font-bold text-blue-900 border-b-4 border-blue-900 bg-blue-50";
                tabLogin.className = "w-1/2 py-4 text-slate-400 font-medium hover:text-blue-800";
            }
        }

        function maskCPF(i) {
            let v = i.value.replace(/\D/g, "");
            v = v.replace(/(\d{3})(\d)/, "$1.$2");
            v = v.replace(/(\d{3})(\d)/, "$1.$2");
            v = v.replace(/(\d{3})(\d{1,2})$/, "$1-$2");
            i.value = v;
        }

        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        function showToast(msg, type="error") {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `pointer-events-auto p-4 rounded-lg shadow-lg text-white font-bold transform transition-all translate-x-full animate-slideIn ${type === 'success' ? 'bg-green-600' : 'bg-red-500'}`;
            toast.innerHTML = `<i class="fa-solid ${type === 'success' ? 'fa-check' : 'fa-circle-exclamation'} mr-2"></i> ${msg}`;
            toast.style.animation = "slideIn 0.3s forwards";
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        const styleSheet = document.createElement("style");
        styleSheet.innerText = `@keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }`;
        document.head.appendChild(styleSheet);
    </script>
</body>
</html>